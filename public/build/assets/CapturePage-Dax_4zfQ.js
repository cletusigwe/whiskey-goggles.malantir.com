import{r as o,j as e,$ as S,S as E}from"./app-Co2BVx7r.js";import{c as I,B as h,t as c,A as P}from"./AppLayout-_8uAItZ8.js";import{P as M}from"./progress-D-n86Hxk.js";import{i as A,c as R}from"./cache-assets-D7TlHRyD.js";/* empty css            *//**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]],z=I("Download",U);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const F=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]],$=I("History",F);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const L=[["path",{d:"M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5",key:"mtk2lu"}],["path",{d:"M13 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-5",key:"120jsl"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}],["path",{d:"m18 22-3-3 3-3",key:"kgdoj7"}],["path",{d:"m6 2 3 3-3 3",key:"1fnbkv"}]],_=I("SwitchCamera",L);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]],O=I("Upload",H),T=({onCapture:v,isModelCached:m})=>{const s=o.useRef(null),i=o.useRef(null),[u,p]=o.useState(!1),[b,w]=o.useState(0),[d,g]=o.useState("available"),[x,y]=o.useState([]),[f,k]=o.useState(!1);o.useEffect(()=>((async()=>{try{const n=(await navigator.mediaDevices.enumerateDevices()).filter(C=>C.kind==="videoinput");if(n.length===0){g("unavailable"),y([]),c.error("No camera detected",{description:"Please ensure a camera is available and permissions are granted."});return}y(n),g("available");const D=n.findIndex(C=>C.label.toLowerCase().includes("back")||C.label.toLowerCase().includes("rear"));w(D>=0?D:0)}catch{g("error"),y([]),c.error("Camera access failed",{description:"Unable to detect cameras. Please check permissions."})}})(),()=>{i.current&&(i.current.getTracks().forEach(t=>t.stop()),i.current=null)}),[]);const j=async()=>{if(d!=="available"||f||!m){d!=="available"?c.error("Camera unavailable",{description:d==="unavailable"?"No camera detected.":"Camera access error."}):m||c.error("Model not downloaded",{description:"Please download the model weights first."});return}k(!0);try{i.current&&(i.current.getTracks().forEach(n=>n.stop()),i.current=null,s.current&&(s.current.srcObject=null));const a=x[b],t=await navigator.mediaDevices.getUserMedia({video:{deviceId:a?{exact:a.deviceId}:void 0}});i.current=t,s.current&&(s.current.srcObject=t,await s.current.play()),p(!0)}catch(a){g("error");let t="Failed to access camera.";a instanceof DOMException&&(a.name==="NotAllowedError"?t="Camera access denied. Please grant permissions.":a.name==="NotFoundError"&&(t="No camera found on this device.",g("unavailable"))),c.error("Camera error",{description:t})}finally{k(!1)}},N=()=>{i.current&&(i.current.getTracks().forEach(a=>a.stop()),i.current=null),s.current&&(s.current.srcObject=null),p(!1)},r=()=>{f||x.length<=1||(w(a=>(a+1)%x.length),N(),j())},l=()=>{if(!s.current||!u)return;const a=document.createElement("canvas");a.width=s.current.videoWidth,a.height=s.current.videoHeight;const t=a.getContext("2d");if(t){t.drawImage(s.current,0,0,a.width,a.height);const n=a.toDataURL("image/jpeg",.8);v(n),N()}};return e.jsx("div",{className:"relative mx-auto w-full max-w-md",children:e.jsxs("div",{className:"relative aspect-[3/4] w-full overflow-hidden rounded-lg",children:[d==="available"&&e.jsx("video",{ref:s,className:"h-full w-full object-cover",playsInline:!0,autoPlay:!0,muted:!0}),!u&&d==="available"&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-amber-200",children:e.jsx(h,{className:"cursor-pointer bg-amber-600 text-white hover:bg-amber-700",onClick:j,disabled:f||!m,children:"Start Camera"})}),d!=="available"&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-amber-200",children:e.jsx(h,{className:"cursor-pointer bg-amber-600 text-white hover:bg-amber-700",onClick:j,disabled:f||!m,children:d==="unavailable"?"No Camera Detected":"Allow Camera"})}),u&&x.length>1&&e.jsx(h,{variant:"outline",size:"icon",className:"absolute top-2 right-2 cursor-pointer border-amber-600 text-amber-800 hover:bg-amber-100",onClick:r,disabled:f||!m,children:e.jsx(_,{className:"h-5 w-5"})}),u&&e.jsx("div",{className:"absolute bottom-4 left-1/2 flex h-16 w-16 -translate-x-1/2 transform cursor-pointer items-center justify-center rounded-full bg-white",onClick:l,children:e.jsx("div",{className:"h-12 w-12 rounded-full bg-red-500"})})]})})},J=()=>{const[v,m]=o.useState(null),[s,i]=o.useState(!1),[u,p]=o.useState(null),[b,w]=o.useState(!0),d=o.useRef(null);o.useEffect(()=>{(async()=>{const l=await A();w(l)})()},[]);const g=async()=>{i(!0),p(null);try{await R((r,l)=>{p({...r,assetName:l})}),c.success("Model assets downloaded",{description:"You can now identify whiskeys offline."}),w(!0)}catch(r){c.error("Download failed",{description:r instanceof Error?r.message:"An unknown error occurred"})}finally{i(!1),p(null)}},x=r=>{m(r),sessionStorage.setItem("capturedImage",r)},y=r=>{var t;const l=(t=r.target.files)==null?void 0:t[0];if(!l)return;if(!["image/jpeg","image/png"].includes(l.type)){c.error("Invalid file type",{description:"Please upload a JPEG or PNG image."});return}if(l.size>5*1024*1024){c.error("File too large",{description:"Please upload an image smaller than 5MB."});return}const a=new FileReader;a.onload=()=>{const n=a.result;m(n),sessionStorage.setItem("capturedImage",n)},a.onerror=()=>{c.error("Failed to read file",{description:"Please try another image."})},a.readAsDataURL(l)},f=async r=>{try{const l=await fetch(`/${r}`);if(!l.ok)throw new Error(`Failed to fetch ${r}`);const a=await l.blob(),t=new FileReader;t.onload=()=>{const n=t.result;m(n),sessionStorage.setItem("capturedImage",n)},t.onerror=()=>{c.error("Failed to load default image",{description:`Could not load ${r}.`})},t.readAsDataURL(a)}catch(l){c.error("Error loading default image",{description:l instanceof Error?l.message:"An unknown error occurred"})}},k=()=>{v?E.visit("/results"):c.error("No image selected",{description:"Please capture, upload, or select a default image first."})},j=()=>{m(null),sessionStorage.removeItem("capturedImage")},N=()=>{d.current&&b&&d.current.click()};return e.jsx(P,{title:"Capture",children:e.jsx("main",{className:"flex min-h-screen flex-col bg-amber-50",children:e.jsx("div",{className:"flex flex-1 flex-col items-center justify-center p-4",children:e.jsxs("div",{className:"mx-auto w-full max-w-md",children:[e.jsxs("div",{className:"mb-8 text-center",children:[e.jsx("h1",{className:"mb-2 text-4xl font-bold text-amber-900",children:"Whiskey Goggles"}),e.jsx("p",{className:"text-amber-700",children:"Snap, identify, and catalog your whiskey collection"}),e.jsx("p",{className:"mt-2 text-sm text-amber-600",children:"All inference is performed locally on your device to save costs."})]}),e.jsxs("div",{className:"rounded-lg bg-white p-4 shadow-sm",children:[s&&u&&e.jsxs("div",{className:"mb-4 w-full",children:[e.jsxs("p",{className:"mb-2 text-sm text-amber-700",children:["Downloading ",u.assetName,"..."]}),e.jsx(M,{value:u.total>0?u.loaded/u.total*100:void 0,className:"h-2 w-full"})]}),v?e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"relative mx-auto mb-4 aspect-[3/4] w-full max-w-xs overflow-hidden rounded-lg",children:e.jsx("img",{src:v,alt:"Captured whiskey",className:"h-full w-full object-contain"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",className:"flex-1 cursor-pointer border-amber-600 text-amber-800 hover:bg-amber-100 disabled:cursor-not-allowed disabled:bg-gray-200 disabled:text-gray-500 disabled:opacity-50",onClick:j,size:"lg",children:"Change Image"}),e.jsx(h,{className:"flex-1 cursor-pointer bg-amber-600 text-white hover:bg-amber-700 disabled:cursor-not-allowed disabled:bg-gray-200 disabled:text-gray-500 disabled:opacity-50",onClick:k,size:"lg",disabled:!b,title:b?void 0:"Download the model to enable analysis",children:"Analyze"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(T,{onCapture:x,isModelCached:b}),b&&!s?e.jsxs(e.Fragment,{children:[e.jsxs(h,{variant:"outline",className:"mt-4 w-full cursor-pointer border-amber-600 text-amber-800 hover:bg-amber-100 disabled:cursor-not-allowed disabled:bg-gray-200 disabled:text-gray-500 disabled:opacity-50",onClick:N,size:"lg",children:[e.jsx(O,{className:"mr-2 h-5 w-5"}),"Upload Image"]}),e.jsx("input",{type:"file",accept:"image/jpeg,image/png",className:"hidden",onChange:y,disabled:!b,ref:d}),e.jsxs("div",{className:"mt-4",children:[e.jsx("p",{className:"mb-2 text-sm text-amber-700",children:"Try a default image:"}),e.jsx("div",{className:"flex justify-between flex-wrap gap-2",children:["whiskey-1.jpg","whiskey-2.jpg","whiskey-3.jpg"].map((r,l)=>e.jsxs(h,{variant:"outline",className:"flex cursor-pointer px-2 py-3 items-center gap-2 border-amber-600 text-amber-800 hover:bg-amber-100 disabled:cursor-not-allowed disabled:bg-gray-200 disabled:text-gray-500 disabled:opacity-50",onClick:()=>f(r),children:[e.jsx("img",{src:`/${r}`,alt:r.replace(".jpg",""),className:"size-8 rounded-sm border border-amber-300 object-cover"}),"Sample ",l+1]},r))})]})]}):!s&&e.jsxs(h,{className:"mt-4 w-full cursor-pointer bg-amber-600 text-white hover:bg-amber-700 disabled:cursor-not-allowed disabled:bg-gray-200 disabled:text-gray-500 disabled:opacity-50",disabled:s,onClick:g,size:"lg",title:s?"Downloading in progress":"Download model to enable image uploads and default images",children:[e.jsx(z,{className:"mr-2 h-5 w-5"}),"Download Model"]}),e.jsx(h,{variant:"outline",className:"mt-4 w-full cursor-pointer border-amber-600 text-amber-800 hover:bg-amber-100 disabled:cursor-not-allowed disabled:bg-gray-200 disabled:text-gray-500 disabled:opacity-50",size:"lg",children:e.jsxs(S,{href:"/history",className:"flex h-full w-full items-center justify-center",children:[e.jsx($,{className:"mr-2 h-5 w-5"}),"View History"]})})]})]})]})})})})};export{J as default};

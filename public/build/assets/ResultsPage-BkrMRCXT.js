import{r as l,S as h,j as e}from"./app-BPVNxkb9.js";import{t as x,n as V,A as Y,B as D}from"./AppLayout-m4WobgZk.js";import{X as J,S as K,a as X,b as G,C as H}from"./card-BrP005gc.js";import{I as Q}from"./input-CnWFgTOB.js";import{P as Z}from"./progress-vzSiX9VQ.js";import{i as ee,g as k}from"./cache-assets-D7TlHRyD.js";/* empty css            */const ie=({whiskeys:f})=>{const[b]=l.useState(20),[g,M]=l.useState(null),[w,R]=l.useState(""),[j,U]=l.useState([]),[q,v]=l.useState([]),[F,N]=l.useState(!0),[O,y]=l.useState(0),[P,S]=l.useState(8),T=((s,a)=>{const[t,n]=l.useState(s);return l.useEffect(()=>{const o=setTimeout(()=>n(s),a);return()=>clearTimeout(o)},[s]),t})(w,300);l.useEffect(()=>{const s=sessionStorage.getItem("capturedImage");if(s)M(s);else{x.error("No image found",{description:"Please capture or upload a whiskey photo first."}),h.visit("/");return}(async()=>{try{N(!0),y(0),S(8);const t=setInterval(()=>{y(c=>{const r=c+25;return r>=100?(clearInterval(t),100):(S(_=>Math.max(1,_-1)),r)})},1e3);if(!await ee())throw new Error("Model assets not cached. Please download them from the homepage.");const o=await k("model"),p=await k("labels"),d=await k("mean_std"),m=URL.createObjectURL(o),i=await window.ort.InferenceSession.create(m,{executionProviders:["wasm"]});URL.revokeObjectURL(m);const u=await W(s,d),C=(await i.run({pixel_values:u})).logits.data,A=$(Array.from(C)).map((c,r)=>({unique_name:p[r],prob:c})),z=A.filter(c=>c.prob>.5).length,I=A.filter(c=>f.some(r=>r.unique_name===c.unique_name)).map(c=>{const r=f.find(_=>_.unique_name===c.unique_name);return{id:r.id,unique_name:r.unique_name,name:r.name,prob:c.prob,stock:r.stock}}).sort((c,r)=>r.prob-c.prob);U(I),v(I.slice(0,b)),N(!1),clearInterval(t),y(100),S(0),x.success("Whiskey analysis complete",{description:`Found ${z} matches above 50% confidence. Displaying the top-${b} results. You can still search within ${I.length} available in database.`})}catch(t){const n=t instanceof Error?t.message:"An unknown error occurred";x.error("Analysis failed",{description:n}),N(!1),h.visit("/")}})()},[f]),l.useEffect(()=>{const s=T.toLowerCase().trim();if(s==="")v(j.slice(0,b));else{const a=j.filter(t=>t.unique_name.toLowerCase().includes(V(s))).sort((t,n)=>n.prob-t.prob);v(a)}},[T,j]);const W=async(s,a)=>{const t=new Image;t.src=s,await new Promise(i=>t.onload=i);const n=document.createElement("canvas");n.width=224,n.height=224;const o=n.getContext("2d");o.drawImage(t,0,0,224,224);const d=o.getImageData(0,0,224,224).data,m=new Float32Array(3*224*224);for(let i=0,u=0;i<d.length;i+=4,u++){const L=d[i]/255,C=d[i+1]/255,E=d[i+2]/255;m[u]=(L-a.mean[0])/a.std[0],m[u+224*224]=(C-a.mean[1])/a.std[1],m[u+2*224*224]=(E-a.mean[2])/a.std[2]}return new window.ort.Tensor("float32",m,[1,3,224,224])},$=s=>{const a=Math.max(...s),t=s.map(o=>Math.exp(o-a)),n=t.reduce((o,p)=>o+p,0);return t.map(o=>o/n)},B=s=>{h.post("/classify",{image:g,whiskey:s.unique_name},{onSuccess:()=>{x.success("Whiskey selected",{description:`You chose ${s.name}.`}),sessionStorage.setItem("selectedWhiskey",JSON.stringify(s))},onError:a=>{x.error("Selection failed",{description:Object.values(a).join(", ")})}})};return e.jsx(Y,{title:"Classify",children:e.jsxs("main",{className:"flex min-h-screen flex-col bg-amber-50",children:[e.jsxs("header",{className:"flex items-center border-b border-amber-200 p-4",children:[e.jsx(D,{variant:"ghost",size:"icon",onClick:()=>h.visit("/"),className:"cursor-pointer text-amber-800",children:e.jsx(J,{className:"h-6 w-6"})}),e.jsx("h1",{className:"flex-1 text-center text-xl font-semibold text-amber-900",children:"Whiskey Identification"}),e.jsx("div",{className:"w-10"})]}),e.jsx("div",{className:"flex flex-1 flex-col items-center p-4",children:e.jsx("div",{className:"w-full max-w-md",children:F?e.jsxs("div",{className:"flex h-full w-full flex-col items-center justify-center",children:[e.jsx("div",{className:"w-full max-w-xs",children:e.jsx(Z,{value:O,className:"mb-4 h-2"})}),e.jsx("p",{className:"text-amber-800",children:"Analyzing your whiskey..."}),e.jsxs("p",{className:"text-sm text-amber-600",children:["Estimated time: ",P," second",P!==1?"s":""," remaining"]})]}):e.jsxs("div",{className:"flex w-full flex-col items-center",children:[e.jsx("div",{className:"relative mb-4 aspect-[3/4] w-full max-w-xs overflow-hidden rounded-lg",children:g&&e.jsx("img",{src:g,alt:"Captured whiskey",className:"h-full w-full object-contain"})}),e.jsx("div",{className:"mb-4 w-full rounded-lg bg-white p-4 shadow-sm",children:e.jsxs("div",{className:"relative",children:[e.jsx(K,{className:"absolute top-1/2 left-3 h-4 w-4 -translate-y-1/2 transform text-amber-600"}),e.jsx(Q,{type:"text",placeholder:"Filter results or search...",value:w,onChange:s=>R(s.target.value),className:"border-amber-300 bg-white pl-9"})]})}),e.jsxs("div",{className:"mb-2 w-full",children:[e.jsx("h2",{className:"text-lg font-medium text-amber-900",children:w?"Search Results":"Top Matches"}),e.jsx("p",{className:"text-sm text-amber-700",children:"Select the correct whiskey"})]}),e.jsx("div",{className:"mb-4 max-h-[400px] w-full overflow-y-auto",children:q.length>0?e.jsx("div",{className:"space-y-2",children:q.map(s=>e.jsx(X,{className:"cursor-pointer transition-colors hover:bg-amber-100",onClick:()=>B(s),children:e.jsx(G,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium text-amber-900",children:f.filter(a=>a.unique_name==s.unique_name)[0].name}),e.jsx("p",{className:"text-xs text-amber-700",children:s.unique_name.includes("750ml")?"750ml":s.unique_name.includes("375ml")?"375ml":s.unique_name.includes("1L")?"1L":s.unique_name.includes("1.75L")?"1.75L":""}),e.jsxs("p",{className:"text-sm text-amber-700",children:["Stock: ",s.stock]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:"w-12 text-right text-sm text-amber-700",children:[(s.prob*100).toFixed(1),"%"]})})]})})},s.id))}):e.jsx("div",{className:"rounded-lg bg-white p-4 text-center",children:e.jsx("p",{className:"text-amber-700",children:"No matches found. Try adjusting your search."})})}),e.jsx("div",{className:"w-full",children:e.jsxs(D,{variant:"outline",className:"w-full cursor-pointer border-amber-600 text-amber-800 hover:bg-amber-100",onClick:()=>h.visit("/"),children:[e.jsx(H,{className:"mr-2 h-4 w-4"}),"Try Another Photo"]})})]})})})]})})};export{ie as default};

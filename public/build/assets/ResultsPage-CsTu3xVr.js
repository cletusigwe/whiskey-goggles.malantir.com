import{r as l,S as h,j as e}from"./app-DbzSqnlF.js";import{t as x,A as V,B as D}from"./AppLayout-DVArcdi2.js";import{a as J,b as X,C as Y}from"./card-BMeuQY_Z.js";import{X as G,S as H,I as K}from"./input-BxjuKAoX.js";import{P as Q}from"./progress-D2YWuv7n.js";import{i as Z,g as k}from"./cache-assets-D7TlHRyD.js";/* empty css            */const le=({whiskeys:p})=>{const[b,M]=l.useState(null),[g,R]=l.useState(""),[w,F]=l.useState([]),[_,j]=l.useState([]),[U,v]=l.useState(!0),[W,N]=l.useState(0),[P,y]=l.useState(4),q=((s,a)=>{const[t,n]=l.useState(s);return l.useEffect(()=>{const o=setTimeout(()=>n(s),a);return()=>clearTimeout(o)},[s]),t})(g,300);l.useEffect(()=>{const s=sessionStorage.getItem("capturedImage");if(s)M(s);else{x.error("No image found",{description:"Please capture or upload a whiskey photo first."}),h.visit("/");return}(async()=>{try{v(!0),N(0),y(4);const t=setInterval(()=>{N(c=>{const r=c+25;return r>=100?(clearInterval(t),100):(y(I=>Math.max(1,I-1)),r)})},1e3);if(!await Z())throw new Error("Model assets not cached. Please download them from the homepage.");const o=await k("model"),f=await k("labels"),d=await k("mean_std"),m=URL.createObjectURL(o),i=await window.ort.InferenceSession.create(m,{executionProviders:["wasm"]});URL.revokeObjectURL(m);const u=await O(s,d),S=(await i.run({pixel_values:u})).logits.data,A=B(Array.from(S)).map((c,r)=>({unique_name:f[r],prob:c})),z=A.filter(c=>c.prob>.5).length,C=A.filter(c=>p.some(r=>r.unique_name===c.unique_name)).map(c=>{const r=p.find(I=>I.unique_name===c.unique_name);return{id:r.id,unique_name:r.unique_name,name:r.name,prob:c.prob,stock:r.stock}}).sort((c,r)=>r.prob-c.prob);F(C),j(C.slice(0,10)),v(!1),clearInterval(t),N(100),y(0),x.success("Whiskey analysis complete",{description:`Found ${z} matches above 50% confidence. Displaying ${C.length} available in database.`})}catch(t){const n=t instanceof Error?t.message:"An unknown error occurred";x.error("Analysis failed",{description:n}),v(!1),h.visit("/")}})()},[p]),l.useEffect(()=>{const s=q.toLowerCase().trim();if(s==="")j(w.slice(0,10));else{const a=w.filter(t=>t.unique_name.toLowerCase().includes(s)).sort((t,n)=>n.prob-t.prob);j(a)}},[q,w]);const O=async(s,a)=>{const t=new Image;t.src=s,await new Promise(i=>t.onload=i);const n=document.createElement("canvas");n.width=224,n.height=224;const o=n.getContext("2d");o.drawImage(t,0,0,224,224);const d=o.getImageData(0,0,224,224).data,m=new Float32Array(3*224*224);for(let i=0,u=0;i<d.length;i+=4,u++){const T=d[i]/255,S=d[i+1]/255,E=d[i+2]/255;m[u]=(T-a.mean[0])/a.std[0],m[u+224*224]=(S-a.mean[1])/a.std[1],m[u+2*224*224]=(E-a.mean[2])/a.std[2]}return new window.ort.Tensor("float32",m,[1,3,224,224])},B=s=>{const a=Math.max(...s),t=s.map(o=>Math.exp(o-a)),n=t.reduce((o,f)=>o+f,0);return t.map(o=>o/n)},L=s=>s.replace(/_/g," ").trim(),$=s=>{h.post("/classify",{image:b,whiskey:s.unique_name},{onSuccess:()=>{x.success("Whiskey selected",{description:`You chose ${L(s.name)}.`}),sessionStorage.setItem("selectedWhiskey",JSON.stringify(s)),h.visit("/edit")},onError:a=>{x.error("Selection failed",{description:Object.values(a).join(", ")})}})};return e.jsx(V,{title:"Classify",children:e.jsxs("main",{className:"flex min-h-screen flex-col bg-amber-50",children:[e.jsxs("header",{className:"flex items-center border-b border-amber-200 p-4",children:[e.jsx(D,{variant:"ghost",size:"icon",onClick:()=>h.visit("/"),className:"cursor-pointer text-amber-800",children:e.jsx(G,{className:"h-6 w-6"})}),e.jsx("h1",{className:"flex-1 text-center text-xl font-semibold text-amber-900",children:"Whiskey Identification"}),e.jsx("div",{className:"w-10"})]}),e.jsx("div",{className:"flex flex-1 flex-col items-center p-4",children:e.jsx("div",{className:"w-full max-w-md",children:U?e.jsxs("div",{className:"flex h-full w-full flex-col items-center justify-center",children:[e.jsx("div",{className:"w-full max-w-xs",children:e.jsx(Q,{value:W,className:"mb-4 h-2"})}),e.jsx("p",{className:"text-amber-800",children:"Analyzing your whiskey..."}),e.jsxs("p",{className:"text-sm text-amber-600",children:["Estimated time: ",P," second",P!==1?"s":""," remaining"]})]}):e.jsxs("div",{className:"flex w-full flex-col items-center",children:[e.jsx("div",{className:"relative mb-4 aspect-[3/4] w-full max-w-xs overflow-hidden rounded-lg",children:b&&e.jsx("img",{src:b,alt:"Captured whiskey",className:"h-full w-full object-contain"})}),e.jsx("div",{className:"mb-4 w-full rounded-lg bg-white p-4 shadow-sm",children:e.jsxs("div",{className:"relative",children:[e.jsx(H,{className:"absolute top-1/2 left-3 h-4 w-4 -translate-y-1/2 transform text-amber-600"}),e.jsx(K,{type:"text",placeholder:"Filter results or search...",value:g,onChange:s=>R(s.target.value),className:"border-amber-300 bg-white pl-9"})]})}),e.jsxs("div",{className:"mb-2 w-full",children:[e.jsx("h2",{className:"text-lg font-medium text-amber-900",children:g?"Search Results":"Top Matches"}),e.jsx("p",{className:"text-sm text-amber-700",children:"Select the correct whiskey"})]}),e.jsx("div",{className:"mb-4 max-h-[400px] w-full overflow-y-auto",children:_.length>0?e.jsx("div",{className:"space-y-2",children:_.map(s=>e.jsx(J,{className:"cursor-pointer transition-colors hover:bg-amber-100",onClick:()=>$(s),children:e.jsx(X,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium text-amber-900",children:L(s.unique_name)}),e.jsx("p",{className:"text-xs text-amber-700",children:s.unique_name.includes("750ml")?"750ml":s.unique_name.includes("375ml")?"375ml":s.unique_name.includes("1L")?"1L":s.unique_name.includes("1.75L")?"1.75L":""}),e.jsxs("p",{className:"text-sm text-amber-700",children:["Stock: ",s.stock]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:"w-12 text-right text-sm text-amber-700",children:[(s.prob*100).toFixed(1),"%"]})})]})})},s.id))}):e.jsx("div",{className:"rounded-lg bg-white p-4 text-center",children:e.jsx("p",{className:"text-amber-700",children:"No matches found. Try adjusting your search."})})}),e.jsx("div",{className:"w-full",children:e.jsxs(D,{variant:"outline",className:"w-full cursor-pointer border-amber-600 text-amber-800 hover:bg-amber-100",onClick:()=>h.visit("/"),children:[e.jsx(Y,{className:"mr-2 h-4 w-4"}),"Try Another Photo"]})})]})})})]})})};export{le as default};
